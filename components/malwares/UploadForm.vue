<template>
  <b-col>
    <b-form-checkbox v-model="folder" name="file_format" switch>
      Upload <b v-if="folder"> Folder </b> <b v-else> Files </b>
    </b-form-checkbox>

    <b-form-file
      v-if="folder"
      v-model="files"
      :state="null"
      size="md"
      placeholder="Choose a folder or drop it here..."
      drop-placeholder="Drop folder here..."
      class="mb-2 mt-2"
      multiple
      directory
      no-traverse
    />
    <b-form-file
      v-else
      v-model="files"
      :state="null"
      size="md"
      placeholder="Choose a file or drop it here..."
      drop-placeholder="Drop file here..."
      class="mb-2 mt-2"
      multiple
    />

    <b-form-input
      v-model="time"
      type="number"
      placeholder="Enter a duration in second (30s by default ...)"
    />

    <b-form-input
      v-model="label"
      type="text"
      placeholder="Enter a label (by default None)"
    />

    <b-progress
      v-if="uploadPercentage !== 0 && uploadPercentage !== 100"
      :value="uploadPercentage"
      show-progress
      animated
      class="mb-2 mt-2"
    />
    <b-btn size="lg" block class="mb-2 mt-3" @click="uploadFile">
      Upload
    </b-btn>
  </b-col>
</template>

<script>
export default {
  name: 'UploadForm',
  data () {
    return {
      files: null,
      time: null,
      label: null,

      uploadPercentage: 0,
      folder: false
    }
  },
  methods: {
    uploadFile () {
      for (const file in this.files) {
        const fileName = this.files[file].name
        console.log(this.files[file].name)
        const formData = new FormData()
        formData.append('file', this.files[file])
        formData.append('name', fileName)
        if (this.time) {
          formData.append('time', this.time)
        } else {
          formData.append('time', 30)
        }

        if (this.label) {
          formData.append('label', this.label)
        }

        this.$api.malware.create(
          formData,
          {
            onUploadProgress: function (event) {
              this.uploadPercentage = parseInt(Math.round((event.loaded / event.total) * 100))
            }
              .bind(this)
          })
          .then((resp) => {
            this.notification(
              'Success',
  `The sample ${resp.name} has been uploaded with a time of ${resp.time}s.`,
  'success'
            )
          })
          .catch((e) => {
            this.notification(
              'An error occured',
  `The following error occured when trying to upload the malware ${name} : ${e}`,
  'danger'
            )
          })
      }
    },
    notification (title, msg, variant) {
      this.$root.$bvToast.toast(msg, {
        title,
        variant,
        autoHideDelay: 10000
      })
    }
  }
}
</script>

<style scoped>

</style>
