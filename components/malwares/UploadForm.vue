<template>
  <b-col>
    <b-form-group label="Upload type" v-slot="{ ariaDescribedby }">
      <b-form-radio-group
        id="btn-upload-type"
        v-model="upload_type"
        :options="upload_type_options"
        :aria-describedby="ariaDescribedby"
        name="radios-btn-default"
        buttons
      ></b-form-radio-group>
    </b-form-group>

     <b-form-group label="Task" v-slot="{ ariaDescribedby }">
      <b-form-radio-group
        id="btn-task"
        v-model="task"
        :options="task_options"
        :aria-describedby="ariaDescribedby"
        name="radios-btn-default"
        buttons
      ></b-form-radio-group>
    </b-form-group>

     <b-form-group label="Format" v-slot="{ ariaDescribedby }">
      <b-form-radio-group
        id="btn-format"
        v-model="format"
        :options="format_options"
        :aria-describedby="ariaDescribedby"
        name="radios-btn-default"
        buttons
      ></b-form-radio-group>
    </b-form-group>

    <label for="finput" class="mt-2">
      <span v-if="upload_type === 'folder'">Folder</span><span v-else>File</span> Input:
    </label>
    <b-form-file
      v-if="upload_type === 'folder'"
      id="finput"
      v-model="files"
      :state="null"
      size="md"
      placeholder="Choose a folder or drop it here..."
      drop-placeholder="Drop folder here..."
      class="mb-2"
      multiple
      directory
      no-traverse
    />
    <b-form-file
      v-else
      id="finput"
      v-model="files"
      :state="null"
      size="md"
      placeholder="Choose a file or drop it here..."
      drop-placeholder="Drop file here..."
      class="mb-2"
      multiple
    />

    <label for="timeinput">Analysis Time:</label>
    <b-form-input
      id="timeinput"
      v-model="time"
      class="mb-2"
      type="number"
      placeholder="Enter a duration in second (30s by default ...)"
    />

    <label for="labelinput" v-if="task === 'analyse'">Malware Label (familly):</label>
    <b-form-input
      v-if="task === 'analyse'"
      id="labelinput"
      v-model="label"
      class="mb-2"
      type="text"
      placeholder="Enter a label (None by default)"
    />

    <label for="export_dll_input" v-if="format === 'dll'">Export DLL name: </label>
    <b-form-input
      v-if="format === 'dll'"
      id="export_dll_input"
      v-model="export_dll"
      class="mb-2"
      type="text"
      placeholder="Enter export name"
    />

    <b-progress
      v-if="uploadPercentage !== 0 && uploadPercentage !== 100"
      :value="uploadPercentage"
      show-progress
      animated
      class="mb-2 mt-2"
    />
    <b-btn size="lg" block class="mb-2 mt-4" @click="uploadFile">
      Upload
    </b-btn>
  </b-col>
</template>

<script>
export default {
  name: 'UploadForm',
  data () {
    return {
      upload_type: 'file',
      upload_type_options: [
        { text: 'File', value: 'file' },
        { text: 'Folder', value: 'folder' }
      ],
      task: 'analyse',
      task_options: [
        { text: 'Analyse', value: 'analyse' },
        { text: 'Unpack', value: 'unpack' }
      ],
      format: 'exe',
      format_options: [
        { text: 'EXE', value: 'exe' },
        { text: 'DLL', value: 'dll' }
      ],
      files: null,
      time: null,
      label: null,
      export_dll: null,
      uploadPercentage: 0
    }
  },
  methods: {
    uploadFile () {
      for (const file in this.files) {
        const fileName = this.files[file].name
        const formData = new FormData()
        formData.append('file', this.files[file])
        formData.append('name', fileName)
        formData.append('is_unpacking', this.is_unpacking)
        if (this.time) {
          formData.append('time', this.time)
        } else {
          formData.append('time', 30)
        }
        if (this.label) {
          formData.append('label', this.label)
        }
        if (this.export_dll) {
          formData.append('export_dll', this.export_dll)
          formData.append('is_dll', true)
        }
        this.$api.malware.create(
          formData,
          {
            onUploadProgress: function (event) {
              this.uploadPercentage = parseInt(Math.round((event.loaded / event.total) * 100))
            }
              .bind(this)
          })
          .then((resp) => {
            this.notification(
              'Success',
  `The sample ${resp.name} has been uploaded with a time of ${resp.time}s.`,
  'success'
            )
          })
          .catch((e) => {
            this.notification(
              'An error occured',
  `The following error occured when trying to upload the malware ${name} : ${e}`,
  'danger'
            )
          })
      }
    },
    notification (title, msg, variant) {
      this.$root.$bvToast.toast(msg, {
        title,
        variant,
        autoHideDelay: 10000
      })
    }
  }
}
</script>

<style scoped>
</style>
