<template>
  <b-col>
    <b-row>
      <b-col cols="2">
        <b-form-group v-slot="{ ariaDescribedby }" label="Upload type">
          <b-form-radio-group
            id="btn-upload-type"
            v-model="upload_type"
            :options="upload_type_options"
            :aria-describedby="ariaDescribedby"
            name="radios-btn-default"
            buttons
          />
        </b-form-group>

        <b-form-group v-slot="{ ariaDescribedby }" label="File Format">
          <b-form-radio-group
            id="btn-format"
            v-model="format"
            :options="format_options"
            :aria-describedby="ariaDescribedby"
            name="radios-btn-default"
            buttons
          />
        </b-form-group>
      </b-col>
      <b-col cols="10">
        <label for="finput" class="mt-2">
          <span v-if="upload_type === 'folder'">Folder</span><span v-else>File</span> Input:
        </label>
        <b-form-file
          v-if="upload_type === 'folder'"
          id="finput"
          v-model="files"
          :state="null"
          size="md"
          placeholder="Choose a folder or drop it here..."
          drop-placeholder="Drop folder here..."
          class="mb-2"
          multiple
          directory
          no-traverse
        />
        <b-form-file
          v-else
          id="finput"
          v-model="files"
          :state="null"
          size="md"
          placeholder="Choose a file or drop it here..."
          drop-placeholder="Drop file here..."
          class="mb-2"
          multiple
        />

        <label for="labelinput">Malware Label (ex: familly):</label>
        <b-form-input
          id="labelinput"
          v-model="label"
          class="mb-2"
          type="text"
          placeholder="Enter a label (None by default)"
        />

        <label v-if="format === 'dll'" for="export_dll_input">Export DLL name: </label>
        <b-form-input
          v-if="format === 'dll'"
          id="export_dll_input"
          v-model="export_dll"
          class="mb-2"
          type="text"
          placeholder="Enter export name to be used as entrypoint"
        />
      </b-col>
    </b-row>
    <b-row>
      <b-col>
        <b-progress
          v-if="uploadPercentage !== 0 && uploadPercentage !== 100"
          :value="uploadPercentage"
          show-progress
          animated
          class="mb-2 mt-2"
        />
        <b-btn
          :disabled="files.length === 0"
          size="lg"
          block
          class="mb-2 mt-4"
          @click="uploadFile"
        >
          Upload
        </b-btn>
      </b-col>
    </b-row>
    <job-form :malwares="malwares" />
  </b-col>
</template>

<script>
import JobForm from '../jobs/JobForm.vue'
export default {
  components: { JobForm },
  name: 'UploadForm',
  data () {
    return {
      upload_type: 'file',
      upload_type_options: [
        { text: 'File', value: 'file' },
        { text: 'Folder', value: 'folder' }
      ],
      format: 'exe',
      format_options: [
        { text: 'EXE', value: 'exe' },
        { text: 'DLL', value: 'dll' }
      ],
      files: [],
      label: null,
      export_dll: null,
      uploadPercentage: 0,
      malwares: []
    }
  },
  methods: {
    uploadFile () {
      if (this.malwares.length !== 0) {
        this.malwares = []
      }
      for (const file in this.files) {
        const fileName = this.files[file].name
        const formData = new FormData()
        formData.append('file', this.files[file])
        formData.append('name', fileName)
        formData.append('task', this.task)
        formData.append('format', this.format)
        if (this.format === 'dll') {
          formData.append('export_dll', this.export_dll)
        }
        if (this.label) {
          formData.append('label', this.label)
        }

        this.$api.malwares.create(
          formData,
          {
            onUploadProgress: function (event) {
              this.uploadPercentage = parseInt(Math.round((event.loaded / event.total) * 100))
            }
              .bind(this)
          })
          .then((resp) => {
            this.notification(
              'Success',
  `The sample ${resp.name} has been uploaded.`,
  'success'
            )
            this.malwares.push(resp)
          })
          .catch((e) => {
            this.notification(
              'An error occured',
  `The following error occured when trying to upload the malware ${name} : ${e}`,
  'danger'
            )
          })
        this.askForJobSubmission()
      }
    },
    notification (title, msg, variant) {
      this.$root.$bvToast.toast(msg, {
        title,
        variant,
        autoHideDelay: 10000
      })
    },
    askForJobSubmission () {
      this.boxTwo = ''
      this.$bvModal.msgBoxConfirm('Would you like to submit some jobs on these samples?', {
        title: 'Jobs Submission',
        size: 'md',
        buttonSize: 'md',
        okVariant: 'primary',
        okTitle: 'YES',
        cancelTitle: 'NO',
        footerClass: 'p-2',
        hideHeaderClose: false,
        centered: true
      })
        .then((value) => {
          if (value) {
            this.$bvModal.show('jobModal')
          }
        })
    }
  }
}
</script>

<style scoped>
</style>
