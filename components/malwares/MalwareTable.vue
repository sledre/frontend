<template>
  <b-col>
    <b-row>
      <b-col>
        <b-form-input v-model="filter" class="mb-4" type="search" placeholder="Enter your filter..." />
      </b-col>
      <b-col sm="2">
        <b-btn
          variant="primary"
          v-b-modal="'jobModal'"
          block
          disabled
        >
          Bulk Add Jobs
          <!-- TODO Add this feature -->
        </b-btn>
      </b-col>
    </b-row>
    <b-table
      id="malware-table"
      :items="malware"
      :fields="fields"
      :filter="filter"
      :per-page="perPage"
      :current-page="currentPage"
      hover
      striped
    >
      <template #cell(show_details)="row">
        <b-button size="sm" class="mr-2" @click="row.toggleDetails">
          {{ row.detailsShowing ? 'Hide' : 'Show' }} Details
        </b-button>
      </template>

      <template #cell(name)="row">
        {{ row.item.name }}
      </template>

      <template #cell(label)="row">
        {{ row.item.label }}
      </template>

      <template #cell(sha256)="row">
        <span v-b-tooltip.hover :title="row.item.name">{{ row.item.sha256 }}</span>
      </template>

      <template #cell(state)="row">
        <analysis-state class="ml-2" :state="row.item.state" />
      </template>

      <template #cell(date)="row">
        {{ $moment(row.item.upload_time).format('LLL') }}
      </template>

      <template #cell(job)="row">
        <b-btn
          variant="primary"
          v-b-modal="'jobModal'"
          @click="setCurrentMalware(row.item)"
          size="sm"
        >
          Add Jobs
        </b-btn>
      </template>

      <template #row-details="row">
        <malware-table-detail :item="row.item" />
      </template>
    </b-table>
    <b-pagination
      v-model="currentPage"
      :total-rows="rows"
      :per-page="perPage"
      aria-controls="malware-table"
      align="center"
    />
    <b-modal
      v-if="currentMalware"
      id="jobModal"
      :title="'Add Jobs for ' + currentMalware.name"
      centered
      @ok="submitJobs"
      @cancel="cancelJobs"
    >
      <template #default="">
        <div>
          <b-form-group>
            <template #label>
              <b>Choose your jobs:</b><br>
              <b-form-checkbox
                v-model="allSelected"
                :indeterminate="indeterminate"
                aria-describedby="jobtypes"
                aria-controls="jobtypes"
                @change="toggleAll"
              >
                {{ allSelected ? 'Un-select All' : 'Select All' }}
              </b-form-checkbox>
            </template>

            <template v-slot="{ ariaDescribedby }">
              <b-form-checkbox-group
                id="jobtypes"
                v-model="selected"
                :options="jobTypes"
                :aria-describedby="ariaDescribedby"
                name="jobtypes"
                class="ml-4"
                aria-label="Individual job type"
                stacked
              ></b-form-checkbox-group>
            </template>
          </b-form-group>

          <b>Choose your analysis time:</b><br>
          <b-form-input
            id="timeinput"
            v-model="selectedTime"
            class="mb-2"
            type="number"
            placeholder="Enter a duration in second (30s by default ...)"
          />

          <span>
            {{ selected.length === 0 ? 'Please select at least one job.' : `${selected.length} job${selected.length === 1 ? '' : 's'} will be submited.` }}
          </span>

        </div>
      </template>

      <template #modal-footer="{ ok, cancel }">
        <b-button size="md" variant="secondary" @click="cancel()">
          Cancel
        </b-button>
        <b-button
          size="md"
          variant="primary"
          @click="ok()"
          :disabled="selected.length === 0"
        >
          Submit Jobs
        </b-button>
      </template>
    </b-modal>
  </b-col>
</template>

<script>
import AnalysisState from './AnalysisState'
import MalwareTableDetail from './MalwareTableDetail.vue'

export default {
  name: 'MalwareTable',
  components: { MalwareTableDetail, AnalysisState },
  props: {
    malware: {
      type: Array,
      default: () => { return [] }
    }
  },
  data () {
    return {
      jobTypes: ['Detours', 'unpack'],
      selected: [],
      selectedTime: null,
      allSelected: false,
      indeterminate: false,
      currentMalware: null,
      taskId: '',
      filter: '',
      perPage: 10,
      currentPage: 1,
      fields: [
        {
          key: 'name',
          label: 'Name',
          sortable: true
        },
        {
          key: 'sha256',
          label: 'SHA256 / Name',
          sortable: true
        },
        {
          key: 'state',
          label: 'State',
          sortable: true,
          class: 'text-center'
        },
        {
          key: 'date',
          label: 'Upload Date',
          sortable: true,
          class: 'text-center'
        },
        {
          key: 'job',
          label: 'Job',
          sortable: true,
          class: 'text-center'
        },
        {
          key: 'show_details',
          label: 'Show Details',
          sortable: false
        }
      ]
    }
  },
  computed: {
    rows () {
      return this.malware.length
    }
  },
  methods: {
    cancelJobs () {
      this.selected = []
    },
    submitJobs () {
      for (const job of this.selected) {
        this.$api.jobs.create(
          {
            job_type: job,
            job_time: this.selectedTime || 30,
            malware: this.currentMalware.sha256
          }
        )
      }
    },
    toggleAll (checked) {
      this.selected = checked ? this.jobTypes.slice() : []
    },
    setCurrentMalware (malware) {
      this.currentMalware = malware
    }
  },
  watch: {
    selected (newValue, oldValue) {
      // Handle changes in individual flavour checkboxes
      if (newValue.length === 0) {
        this.indeterminate = false
        this.allSelected = false
      } else if (newValue.length === this.jobTypes.length) {
        this.indeterminate = false
        this.allSelected = true
      } else {
        this.indeterminate = true
        this.allSelected = false
      }
    }
  }
}
</script>

<style scoped>
</style>
