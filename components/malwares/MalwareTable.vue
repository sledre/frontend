<template>
  <b-col>
    <b-row>
      <b-col>
        <b-form-input v-model="filter" class="mb-4" type="search" placeholder="Enter your filter..." />
      </b-col>
      <b-col sm="2">
        <b-btn v-if="taskId === ''" variant="primary" block @click="initDatasetWorkflow()">
          <b-spinner v-if="generatingDataset" small class="mr-2" />
          <span>{{ generatingDataset ? "Generating..." : "Dataset Generation" }}</span>
        </b-btn>
        <b-btn v-else variant="danger" block @click="downloadDataset()">
          Download Dataset
        </b-btn>
      </b-col>
    </b-row>
    <b-table
      id="malware-table"
      :items="malware"
      :fields="fields"
      :filter="filter"
      :per-page="perPage"
      :current-page="currentPage"
      hover
      striped
    >
      <template #cell(show_details)="row">
        <b-button size="sm" class="mr-2" @click="row.toggleDetails">
          {{ row.detailsShowing ? 'Hide' : 'Show' }} Details
        </b-button>
      </template>

      <template #cell(name)="row">
        {{ row.item.name }}
      </template>

      <template #cell(label)="row">
        {{ row.item.label }}
      </template>

      <template #cell(sha256)="row">
        <span v-b-tooltip.hover :title="row.item.name">{{ row.item.sha256 }}</span>
      </template>

      <!-- <template #cell(state)="row">
        {{ stateString[row.item.state] }}
        <analysis-state class="ml-2" :state="row.item.state" />
      </template> -->

      <template #cell(date)="row">
        {{ $moment(row.item.upload_time).format('LLL') }}
      </template>

      <template #row-details="row">
        <b-card>
          <b-row class="mb-2">
            <b-col sm="1" class="text-sm-left">
              <b>Name</b>
            </b-col>
            <b-col>{{ row.item.name }}</b-col>
          </b-row>

          <b-row class="mb-2">
            <b-col sm="1" class="text-sm-left">
              <b>MD5</b>
            </b-col>
            <b-col>{{ row.item.md5 }}</b-col>
          </b-row>

          <b-row class="mb-2">
            <b-col sm="1" class="text-sm-left">
              <b>SHA256</b>
            </b-col>
            <b-col>{{ row.item.sha256 }}</b-col>
          </b-row>

          <b-row class="mb-2">
            <b-col sm="1" class="text-sm-left">
              <b>SHA512</b>
            </b-col>
            <b-col>{{ row.item.sha512 }}</b-col>
          </b-row>

          <!-- <b-row class="mb-2">
            <b-col sm="1" class="text-sm-left">
              <b>Tags</b>
            </b-col>
            <b-col>
              <b-badge
              v-for="tag in row.item.tags"
              :key="tag"
              variant="secondary"
              class="mr-2 shadow"
              >
                {{ tag }}
              </b-badge>
            </b-col>
          </b-row> -->

          <b-row class="mb-2">
            <b-col>
              <b-btn
                id="bt-download-traces"
                class="mr-2"
                :disabled="row.item.state !== 'DONE'"
                @click="downloadTraces(row.item.sha256)"
              >
                Download Traces
              </b-btn>

              <b-button
                class="mr-2 ml-2"
                variant="danger"
                :disabled="row.item.state === 'RUNNING'"
                @click="deleteFile(row.item.sha256)"
              >
                Delete file
              </b-button>

              <b-tooltip target="bt-download-traces" triggers="hover">
                Results will be downloaded
              </b-tooltip>
            </b-col>
          </b-row>
          <b-row>
            <jobs-table :jobs="row.item.jobs" />
          </b-row>
        </b-card>
      </template>
    </b-table>
    <b-pagination
      v-model="currentPage"
      :total-rows="rows"
      :per-page="perPage"
      aria-controls="malware-table"
      align="center"
    />
  </b-col>
</template>

<script>
// import AnalysisState from './AnalysisState'
// TODO : Find a way to send State of a Malware
import JobsTable from './JobsTable'

export default {
  name: 'MalwareTable',
  components: { JobsTable }, // AnalysisState },
  props: {
    malware: {
      type: Array,
      default: () => { return [] }
    }
  },
  data () {
    return {
      generatingDataset: false,
      taskId: '',
      filter: '',
      perPage: 10,
      currentPage: 1,
      fields: [
        {
          key: 'sha256',
          label: 'SHA256 / Name',
          sortable: true
        },
        {
          key: 'label',
          label: 'Label',
          sortable: true,
          class: 'text-center'
        },
        /* {
          key: 'state',
          label: 'State',
          sortable: true,
          class: 'text-center'
        }, */
        {
          key: 'date',
          label: 'Upload Date',
          sortable: true
        },
        {
          key: 'show_details',
          label: 'Show Details',
          sortable: false
        }
      ]
    }
  },
  computed: {
    rows () {
      return this.malware.length
    }
  },
  methods: {
    downloadTraces (id) {
      window.open(`/api/malwares/${id}/download_traces/`)
    },
    deleteFile (id) {
      this.$api.malwaress.delete(id)
    },
    async initDatasetWorkflow () {
      this.generatingDataset = true
      const taskId = (await this.$axios.$get('/dataset/generate/')).task_id
      while ((await this.$axios.$get(`/dataset/check/${taskId}/`)).status === 'KO') {
        await this.sleep(2000)
      }
      this.taskId = taskId
    },
    downloadDataset () {
      window.open(`/api/dataset/download/${this.taskId}/`)
    },
    sleep (time) {
      return new Promise(resolve => setTimeout(resolve, time))
    }
  }
}
</script>

<style scoped>
</style>
