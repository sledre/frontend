<template>
  <b-col>
    <b-form-input v-model="filter" type="search" placeholder="Enter your filter..."></b-form-input>
    <b-table :items="malware" :fields="fields" :filter="filter" striped>
      <template #cell(show_details)="row">
        <b-button size="sm" class="mr-2" @click="row.toggleDetails">
          {{ row.detailsShowing ? 'Hide' : 'Show' }} Details
        </b-button>
      </template>

      <template #cell(time)="row">
        {{ row.item.time }}
      </template>

      <template #cell(state)="row">
        {{ stateString[row.item.state] }}
        <analysis-state class="ml-2" :state="row.item.state" />
      </template>

      <template #cell(date)="row">
        {{ $moment(row.item.date).format('LLL') }}
      </template>

      <template #row-details="row">
        <b-card>
          <b-row class="mb-2">
            <b-col sm="1" class="text-sm-left">
              <b>md5</b>
            </b-col>
            <b-col>{{ row.item.md5 }}</b-col>
          </b-row>

          <b-row class="mb-2">
            <b-col sm="1" class="text-sm-left">
              <b>sha256</b>
            </b-col>
            <b-col>{{ row.item.sha256 }}</b-col>
          </b-row>

          <b-row class="mb-2">
            <b-col sm="1" class="text-sm-left">
              <b>sha512</b>
            </b-col>
            <b-col>{{ row.item.sha512 }}</b-col>
          </b-row>

          <b-row class="mb-2">
            <b-col sm="1" class="text-sm-left">
              <b>Content Type</b>
            </b-col>
            <b-col>{{ row.item.content_type }}</b-col>
            <b-col>
              <b-btn
                id="bt-download-traces"
                :disabled="row.item.state !== 'ANALYZED'"
                @click="downloadTraces(row.item.sha256)"
              >
                Download Traces
              </b-btn>
              <b-tooltip target="bt-download-traces" triggers="hover">
                Traces will be downloaded in JSON format
              </b-tooltip>
            </b-col>
          </b-row>
        </b-card>
      </template>
    </b-table>
  </b-col>
</template>

<script>
import AnalysisState from './AnalysisState'
export default {
  name: 'MalwareTable',
  components: { AnalysisState },
  props: {
    malware: {
      type: Array,
      default: () => { return [] }
    }
  },
  data () {
    return {
      filter: '',
      fields: [
        {
          key:'sha256',
          sortable: true
        },
        {
          key: 'time',
          label: 'Analysis Time',
          sortable: true
        },
        {
          key: 'state',
          sortable: true
        },
        {
          key: 'date',
          label: 'Upload Date',
          sortable: true
        },
        {
          key:'show_details',
          sortable: false
        }
      ],
      stateString: {
        ANALYZING: 'Analyzing',
        ANALYZED: 'Analyzed',
        NOT_ANALYZED: 'Not Analyzed'
      }
    }
  },
  methods: {
    downloadTraces (id) {
      window.open(`/api/malwares/${id}/download_traces/`)
    },
    sort (field) {
      this.malware.sort();
    }
  }
}
</script>
